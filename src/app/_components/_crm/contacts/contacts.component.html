<ng-template #deldialog>
  <h1 mat-dialog-title class="kb-danger">Delete Contact</h1>
  <div mat-dialog-content>
    Would you like to delete <span class="text-danger">{{contact.email}}</span> contact?
  </div>
  <div mat-dialog-actions class="justify-content-end">
    <button mat-button mat-dialog-close cdkFocusInitial [color]="'primary'">No</button>
    <button mat-button mat-dialog-close (click)="deleteContact()" class="text-danger">Yes</button>
  </div>
</ng-template>
<ng-template #adddialog>
  <h1 mat-dialog-title>Add Contact</h1>
  <div mat-dialog-content>
    <mat-form-field appearance="fill">
      <mat-label>First Name</mat-label>
      <input matInput type="text" placeholder="first name" [(ngModel)]="contact.firstname">
    </mat-form-field>
    <mat-form-field appearance="fill">
      <mat-label>Last Name</mat-label>
      <input matInput type="text" placeholder="last name" [(ngModel)]="contact.lastname">
    </mat-form-field>
    <mat-error *ngIf="hasError">{{hasError}}</mat-error>
    <mat-form-field appearance="fill" [class.mat-form-field-invalid]="hasError">
      <mat-label>Email</mat-label>
      <input matInput type="text" placeholder="email" [(ngModel)]="contact.email" required>
    </mat-form-field>
    <mat-form-field appearance="fill">
      <mat-label>Phone</mat-label>
      <input matInput type="phone" placeholder="phone" [(ngModel)]="contact.phone">
    </mat-form-field>
    <mat-form-field appearance="fill" (click)="filterListData($event)">
      <mat-label>Subscribe to Lists</mat-label>
      <mat-chip-list #listChipList aria-label="List selection">
          <mat-chip
              *ngFor="let data of selectedLists, index as i"
              (removed)="removeSelectedList(i)">
              {{data.name}}
              <button matChipRemove>
              <mat-icon>cancel</mat-icon>
              </button>
          </mat-chip>
      </mat-chip-list>
      <input matInput type="text"
          #searchListInp
          placeholder="Select multiples..."
          (input)="filterListData($event)"
          [matAutocomplete]="listAuto"
          [matChipInputFor]="listChipList"
          [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
          class="kb-act-searchinp pt-1">
      <mat-autocomplete autoActiveFirstOption #listAuto="matAutocomplete" (optionSelected)="addSelectedList($event, searchListInp)">
          <mat-option *ngFor="let option of filteredOptions.lists" [value]="option" [disabled]="filteredTempIds.lists.includes(option.uniqueid)">
            {{option.name}}
          </mat-option>
      </mat-autocomplete>
  </mat-form-field>
  <mat-form-field appearance="fill"  (click)="filterTagData($event)">
    <mat-label>Add Tags</mat-label>
    <mat-chip-list #tagChipList aria-label="Tag selection">
        <mat-chip
            *ngFor="let data of selectedTags, index as i"
            (removed)="removeSelectedTag(i)">
            {{data.name}}
            <button matChipRemove>
            <mat-icon>cancel</mat-icon>
            </button>
        </mat-chip>
    </mat-chip-list>
    <input matInput type="text"
        #searchTagInp
        [formControl]="tagCtrl"
        placeholder="Select multiples..."
        (input)="filterTagData($event)"
        [matAutocomplete]="tagAuto"
        [matChipInputFor]="tagChipList"
        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
        (matChipInputTokenEnd)="addtag($event)"
        class="kb-act-searchinp pt-1">
    <mat-autocomplete autoActiveFirstOption #tagAuto="matAutocomplete" (optionSelected)="addSelectedTag($event, searchTagInp)">
        <mat-option *ngFor="let option of filteredOptions.tags" [value]="option" [disabled]="filteredTempIds.tags.includes(option.uniqueid)">
          {{option.name}}
        </mat-option>
    </mat-autocomplete>
</mat-form-field>
  </div>
  <div mat-dialog-actions class="justify-content-end">
      <button mat-button mat-dialog-close class="text-danger">Cancel</button>
      <button mat-button mat-dialog-close (click)="addContact()" cdkFocusInitial color="primary">Add</button>
  </div>
</ng-template>
<ng-template #importdialog>
  <h1 mat-dialog-title>Import Contacts</h1>
  <div mat-dialog-content>
    <div class="mb-3">
      <div>
        <button mat-raised-button color="primary" (click)="downloadInp.click()" class="mr-3">Select File (.xlsx)</button>
        <button mat-raised-button color="accent" (click)="downloaduploadformat()"><i class="fa-solid fa-download mr-2"></i>Template</button>
      </div>
      <div class="mt-2">
        <span *ngIf="document" class="kb-info-tag small rounded px-2 py-1">{{document.name}}</span>
        <input #downloadInp name="download" type="file" accept=".xlsx" (change)="documentChangeEvent($event)" [formControl]="fileFormControl" class="d-none"> 
        <mat-error *ngIf="error">{{errormessage}}</mat-error>
        <ng-template *ngIf="fileFormControl.hasError('required')">
          Please Upload File.
        </ng-template> 
      </div>
    </div>
    <mat-form-field *ngIf="document" class="kb-full-width" appearance="fill" (click)="filterListData($event)">
      <mat-label>Select Lists</mat-label>
      <mat-chip-list #listChipList aria-label="List selection">
        <mat-chip
          *ngFor="let data of selectedLists; index as i"
          (removed)="removeSelectedList(i)">
          {{ data?.name }}
          <button matChipRemove>
          <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip>
      </mat-chip-list>
      <input matInput
        type="text"
        #searchListInp
        placeholder="Select multiples..."
        (input)="filterListData($event)"
        [matAutocomplete]="listAuto"
        [matChipInputFor]="listChipList"
        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
        class="kb-act-searchinp w-100 pt-1">
      <mat-autocomplete
        #listAuto="matAutocomplete"
        (optionSelected)="addSelectedList($event, searchListInp)">
        <mat-option
          *ngFor="let option of filteredOptions.lists"
          [value]="option"
          [disabled]="filteredTempIds.lists?.includes(option.uniqueid)">
          {{ option.name }}
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>      
   <span *ngIf="document" class="kb-fnt">(Leave empty if you don't want to subscribe to any list)</span>
    <div class="kb-spinner" *ngIf="spinner">
      <mat-spinner></mat-spinner>
    </div>
  </div>
  <div mat-dialog-actions class="justify-content-end">
    <button mat-button mat-dialog-close cdkFocusInitial class="text-danger">Cancel</button>
    <button mat-button [color]="'primary'" [disabled]="fileFormControl.invalid || document?.length == 0" (click)="uploadcontacts()">Import</button>
    <!-- <button mat-raised-button mat-dialog-close [color]="'primary'" [disabled]="filteredTempIds.lists?.length > 0" (click)="uploadcontacts('all')">Import All</button> -->
  </div>
</ng-template>
<ng-template #exportdialog>
  <h1 mat-dialog-title>Export Contacts</h1>
  <div mat-dialog-content>
    <mat-form-field class="kb-full-width" appearance="fill" (click)="filterListData($event)">
      <mat-label>Select Lists</mat-label>
      <mat-chip-list #listChipList aria-label="List selection">
        <mat-chip
          *ngFor="let data of selectedLists; index as i"
          (removed)="removeSelectedList(i)">
          {{ data?.name }}
          <button matChipRemove>
          <mat-icon>cancel</mat-icon>
          </button>
        </mat-chip>
      </mat-chip-list>
      <input
        matInput
        type="text"
        #searchListInp
        placeholder="Select multiples..."
        (input)="filterListData($event)"
        [matAutocomplete]="listAuto"
        [matChipInputFor]="listChipList"
        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
        class="kb-act-searchinp w-100 pt-1">
      <mat-autocomplete
        #listAuto="matAutocomplete"
        (optionSelected)="addSelectedList($event, searchListInp)">
        <mat-option
          *ngFor="let option of filteredOptions.lists"
          [value]="option"
          [disabled]="filteredTempIds.lists?.includes(option.uniqueid)">
          {{ option.name }}
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>
    <span class="kb-fnt">(Leave empty if you don't want to subscribe to any list)</span>
    <mat-form-field class="kb-full-width" appearance="fill">
      <mat-label>Export name (Optional)</mat-label>
      <input matInput type="text" placeholder="Enter export name" [(ngModel)]="exportname">
    </mat-form-field>
    <span class="kb-fnt">(This is the name given to exported excel file)</span>
    <div class="kb-fnt py-4">
      <div >Select fields to export (Optional)</div>
  <div><mat-checkbox [formControl]="tagsFormControl">Tags</mat-checkbox></div>
  <div><mat-checkbox [formControl]="fieldsFormControl">Fields</mat-checkbox></div>
    </div>
    <div class="kb-spinner" *ngIf="spinner">
      <mat-spinner></mat-spinner>
    </div>
  </div>
  <div mat-dialog-actions class="justify-content-end">
    <button mat-button mat-dialog-close class="text-danger">Cancel</button>
    <button mat-button  [color]="'primary'" (click)="exportcontact(true,'single')">Export</button>
    <!-- <button mat-raised-button mat-dialog-close [color]="'primary'" [disabled]="filteredTempIds.lists?.length > 0" (click)="exportcontact(false,'all')">Export All</button> -->
  </div>
</ng-template>
<div class="container-fluid">
    <mat-progress-bar *ngIf="fetching" mode='indeterminate'></mat-progress-bar>
    <div class="row">
        <mat-form-field appearance="fill" class="col-md-3">
            <mat-label>Search Contacts</mat-label>
            <input matInput #searchInp (input)="searchContacts(searchInp, sortInp, listInp, tagInp)" type="text" placeholder="Search Contacts">
            <i class="fa-solid fa-magnifying-glass"></i>
        </mat-form-field>
        <mat-form-field appearance="fill" class="col-md-2">
            <mat-label>Sort By</mat-label>
            <mat-select #sortInp name="kbfilter" value='created_at DESC' (valueChange)="searchContacts(searchInp, sortInp, listInp, tagInp)">
                <mat-option [value]="'created_at ASC'">ASC By Create</mat-option>
                <mat-option [value]="'created_at DESC'">DESC By Create</mat-option>
                <mat-option [value]="'updated_at ASC'">ASC By Update</mat-option>
                <mat-option [value]="'updated_at DESC'">DESC By Update</mat-option>
                <mat-option [value]="'email ASC'">ASC By Email</mat-option>
                <mat-option [value]="'email DESC'">DESC By Email</mat-option>
                <mat-option [value]="'firstname ASC'">ASC By Name</mat-option>
                <mat-option [value]="'firstname DESC'">DESC By Name</mat-option>
            </mat-select>
        </mat-form-field>
        <mat-form-field appearance="fill" class="col-md-2">
            <mat-label>Filter By List</mat-label>
            <mat-select #listInp name="listfilter" value='' (valueChange)="searchContacts(searchInp, sortInp, listInp, tagInp)">
                <mat-option value="" selected>All</mat-option>
                <mat-option value="NULL" selected>None</mat-option>
                <mat-option *ngFor="let list of lists" [value]="list.uniqueid">
                    {{list.name | titlecase}}
                  </mat-option>
            </mat-select>
        </mat-form-field>
        <mat-form-field appearance="fill" class="col-md-2">
          <mat-label>Filter By Tag</mat-label>
          <mat-select #tagInp name="tagfilter" value='' (valueChange)="searchContacts(searchInp, sortInp, listInp, tagInp)">
              <mat-option value="" selected>All</mat-option>
              <mat-option *ngFor="let tag of tags" [value]="tag.uniqueid">
                  {{tag.name | titlecase}}
                </mat-option>
          </mat-select>
        </mat-form-field>
        <div class="col-md-3 mt-2 text-right">
          <button mat-raised-button color="accent" [matMenuTriggerFor]="menu">
            Import/Export <mat-icon>import_export</mat-icon>
          </button>
          <mat-menu #menu="matMenu" xPosition="before">
            <button mat-menu-item (click)="openDialog(importdialog, '')">
              <span>Import</span>
              <i class="fa-solid fa-upload ml-2"></i>
            </button>
            <button mat-menu-item (click)="openDialog(exportdialog, '')">
              <span>Export</span>
              <i class="fa-solid fa-download ml-2"></i>
            </button>
          </mat-menu>
          <button mat-raised-button (click)="openDialog(adddialog, contactObj)" color="primary" class="ml-3">Add Contact <i class="fas fa-plus"></i></button>
        </div>
    </div>
    <div class="row">
      <div class="col-12">
        <table class="table kb-table"  dataSource="contacts">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let contact of pagecontacts; index as i">
              <td [routerLink]="['/crm/contact/'+contact.uniqueid]" class="kb-td-link">
                  <span class="kb-table-icon mr-1">{{contactIcon(contact) | uppercase}}</span>
                  {{(contact.firstname ? contact.firstname : '--') + ' ' + (contact.lastname ? contact.lastname : '') | titlecase}}
              </td>
              <td [routerLink]="['/crm/contact/'+contact.uniqueid]" class="kb-td-link"><span class="text-lowercase">{{ contact.email | lowercase }}</span></td>
              <td>{{ contact.phone ? contact.phone : '--' }}</td>
              <td>{{ contact.created_at | date:'medium' }}</td>
              <td>
                <span class="d-flex">
                  <i mat-ripple matTooltip="Edit" matTooltipPosition="above" [routerLink]="['/crm/contact/'+contact.uniqueid]" class="fa fa-pencil px-4 kb-table-action-icon rounded"></i>
                  <i mat-ripple matTooltip="Delete" matTooltipPosition="above" (click)="openDialog(deldialog, contact)" class="fa fa-trash-alt px-4 kb-table-action-icon kb-icon-del rounded"></i>
                </span>
              </td>                        
            </tr>
            
          </tbody>
        </table>
        <mat-paginator  #paginator [length]="contacts.length" [pageSize]="20" [pageSizeOptions]="[20, 50, 100, 200, 500]" aria-label="Select page" (page)="getpagecontacts($event)"></mat-paginator>
      </div>
      
    </div>
</div>

