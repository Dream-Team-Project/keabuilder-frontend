<div id="funnelcontainer">
    <mat-progress-bar *ngIf="searching" mode='indeterminate'></mat-progress-bar>
    <app-build-funnel [DialogToggle]="DialogParentToggle"></app-build-funnel>

    <ng-template #dialogduplicate>
        <h1 mat-dialog-title >{{actionname}} Step</h1>
        <div mat-dialog-content>
            Would you like to {{actionname}} <span class="text-primary">{{selfunnelstep.page_name}}</span> Step?
        </div>
        <div mat-dialog-actions class="justify-content-end">
      
            <mat-form-field appearance="fill" class="kb-full-width">
              <mat-label>Funnels</mat-label>
              <mat-select name="newfunnelid" [(ngModel)]="newfunnelid" >
                <span *ngFor="let funnel of funnels">
                    <mat-option *ngIf="dialogfunnelset!=funnel.uniqueid"  [value]="funnel.uniqueid">
                        {{funnel.name}}
                    </mat-option>
                </span>
              </mat-select>
            </mat-form-field>
            <button mat-button class="text-info" mat-dialog-close >No</button>
            <button mat-button mat-dialog-close class="text-danger" (click)="dupanotherdes(selfunnelstep)">Yes</button>
      
        </div>
    </ng-template>

    <div id="kb-offcanvas-actions" *ngIf="sidebar.open">
        <div class="offcanvas offcanvas-right p-4 offcanvas-on" [class.loadEffectFromLeftsidebar]="sidebar.anim.open" [class.loadEffectFromLeftsidebarClose]="sidebar.anim.close">
            
            <i class="fas fa-times" (click)="hidepopupsidebar()"></i>

            <span *ngIf="!duplpopupfunnel">

                <div *ngIf="firstpart">
                        <div *ngIf="funneltostep">
                            <h6><strong>Copy Funnel URL</strong></h6>
                            <hr>
                            
                        <mat-form-field class="kb-full-width" appearance="fill">
                            <mat-label>Funnel Url</mat-label>
                            <textarea matInput readonly rows="3" name="funnelurlonly" #userinput >{{funnelurl}}</textarea>
                        </mat-form-field>
                        
                        <button mat-raised-button color="primary" (click)="copyInputMessage(userinput)" >
                            <i class="far fa-copy"></i> Copy Funnel Url
                        </button>
                    </div>

                    <div *ngIf="!funneltostep">
                        <h6><strong>Copy Step URL</strong></h6>
                        <hr>
                        <mat-form-field class="kb-full-width" appearance="fill">
                        <mat-label>Step Url</mat-label>
                        <textarea matInput readonly rows="3" name="funnelurlonly" #userinput >{{funnelurl}}</textarea>
                        </mat-form-field>
                        
                        <button mat-raised-button color="primary" (click)="copyInputMessage(userinput)" >
                            <i class="far fa-copy"></i> Copy Step Url
                        </button>
                        
                        <hr>
                        
                        <h6><strong>Copy Page URL</strong></h6>
                        <hr>
                        <mat-form-field class="kb-full-width" appearance="fill">
                        <mat-label>Page Url</mat-label>
                        <textarea matInput readonly rows="3" name="funnelurlonly" #userinput2 >{{pageurl}}</textarea>
                        </mat-form-field>
                        
                        <button mat-raised-button color="primary" (click)="copyInputMessage(userinput2)" >
                            <i class="far fa-copy"></i> Copy Url
                        </button>
                    </div>
                </div>

                <div *ngIf="!firstpart && !colortheme">
                    <h6><strong>Archive</strong></h6>
                    <hr>
                    
                    <mat-form-field class="kb-full-width" appearance="fill">
                        <mat-label>Archive Reason</mat-label>
                        <textarea matInput [(ngModel)]="reason" rows="8" name="reasons"></textarea>
                        <small>Optional</small>
                    </mat-form-field>
            
                    <p>It will help you remember why you archive it!</p>
                    
                    <button mat-raised-button color="primary" type="submit" (click)="makearchive()" *ngIf="shwobtnfirst" >
                        <i class="fas fa-archive"></i> Archive Funnel
                    </button>

                    <button mat-raised-button color="primary" type="submit" (click)="makearchivestep()" *ngIf="!shwobtnfirst" >
                        <i class="fas fa-archive"></i> Archive Funnel Step
                    </button>
                </div>

                <div *ngIf="colortheme">
                    <h6><strong>Change Color Badge</strong></h6>
                    <hr>

                    <mat-form-field appearance="fill" class="kb-full-width" >
                        <mat-label>Badge Color</mat-label>
                        <mat-select name="badgecolor" [(ngModel)]="badgecolor">
                        <mat-option value="">None</mat-option>
                        <mat-option value="primary">Primary</mat-option>
                        <mat-option value="secondary">Secondary</mat-option>
                        <mat-option value="success">Success</mat-option>
                        <mat-option value="warning">Warning</mat-option>
                        <mat-option value="info">Info</mat-option>
                        <mat-option value="danger">Danger</mat-option>
                        </mat-select>
                    </mat-form-field>

                    <button mat-raised-button color="primary" (click)="savesteptheme()" ><i class="fas fa-check-circle"></i> Save Color</button>

                </div>

            </span>

            <div *ngIf="duplpopupfunnel">

                <h6><strong>Duplicate '{{dupfunnelname}}' Funnel</strong></h6>
                <hr>

                <mat-form-field class="kb-full-width" appearance="fill">
                    <mat-label>Name</mat-label>
                    <input type="text" matInput [(ngModel)]="form.funnelname" name="funnelname" [formControl]="funneltitleFormControl" placeholder="Ex. 10 Days to Productivity" required minlength="3" >
                    <mat-error *ngIf="funneltitleFormControl.hasError('required')">
                      Name is <strong>required</strong>
                    </mat-error>
                    <mat-error *ngIf="funneltitleFormControl.hasError('minlength')">
                      Name must be at least <strong>3</strong> characters
                    </mat-error>
                </mat-form-field>

                <mat-form-field class="kb-full-width" appearance="fill">
                    <mat-label> Subdomain</mat-label>
                    <input type="text" (keyup)="form.subdomain = removespecialcharwithsmall(form.subdomain)" required matInput [formControl]="subdomainFormControl" placeholder="Ex. Keabuilder" [(ngModel)]="form.subdomain">
                    <span matSuffix>.keapages.com</span>
                    <mat-error *ngIf="subdomainFormControl.hasError('required')">
                      Subdomain Name is <strong>required</strong>
                    </mat-error>
                    <mat-error *ngIf="subdomainFormControl.hasError('minlength')">
                      Subdomain must be at least <strong>3</strong> characters
                    </mat-error>
                    <mat-error *ngIf="subdomainFormControl.hasError('maxlength')">
                      Subdomain must be at most <strong>20</strong> characters
                    </mat-error>
                </mat-form-field>

                <button mat-raised-button color="primary" (click)="makeduplicatefunnel()" >Duplicate <i class="fas fa-copy"></i></button>

            </div>

            <img src="/assets/images/funnel/funnel1.png" class="img-fluid" alt="">

        </div>
    </div>
    <div class="offcanvas-overlay " *ngIf="sidebar.open" (click)="hidepopupsidebar()" [class.slowVisible]="sidebar.anim.open" [class.slowHide]="sidebar.anim.close"></div>
    
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
              <mat-form-field  appearance="fill" class="col-8">
                <mat-label>Search Funnel</mat-label>
                <input matInput type="text" name="searchweb" (keyup)="searchpage($event)" placeholder="Search Funnel">
                <i class="fa-solid fa-magnifying-glass"></i>
              </mat-form-field>
              <mat-form-field appearance="fill" class="col-4">
                <mat-label>Sort By</mat-label>
                <mat-select name="kbfilter" [(ngModel)]="selstatusshow" (ngModelChange)="applykbfilter()">
                  <mat-option value="nameasc" >ASC By Name</mat-option>
                  <mat-option value="namedesc">DESC By Name</mat-option>
                  <mat-option value="dateasc" >ASC By Date</mat-option>
                  <mat-option value="datedesc">DESC By Date</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
            <div class="col-md-4 text-right">
                <button mat-raised-button color="primary" (click)="openDialog($event)">
                    Create Funnel <i class="far fas fa-plus"></i>
                </button>
            </div>
        </div>

        <div class="row" *ngIf="funnelnotfound">
            <div class="col-md-4"></div>
            <div class="col-md-4 text-center">
                <img width="" src="/assets/images/funnel/funnel2.png" class="img-fluid" alt="">
            </div>
        </div>

        <div class="steps-group row keabuilder-container mt-5">
            
            <div class="col-md-12 mb-4" *ngFor="let funnel of funnels; index as i">
                    <mat-accordion>
                        <div class="keabuilder-board">
                            <mat-expansion-panel (opened)="panelOpenState = true" (closed)="panelOpenState = false" >
                            <mat-expansion-panel-header>          
                    <!-- <header class="keabuilder-board-header"> -->
                        <mat-panel-title class="row"  > 
                        <div class="keabuilder-title-board line-ellipsis col-md-4"><span class="fnt">{{funnel.name | titlecase}}</span> <input type="text" [(ngModel)]="funnel.name" name="funnelname" (blur)="changestepnamesoutside(funnel.id,funnel.name)" ></div>
                        <!-- <div class="keabuilder-attachment d-flex align-items-center font-size-small pr-2 col-md-2"  matTooltip="Group Tags" matTooltipPosition="above" *ngIf="funnel.grouptags!='' && funnel.grouptags!=null" >
                            <i class="fas fa-tags mr-1"></i> {{funnel.grouptags}}
                        </div> -->
                        <div class=" col-md-2"><span>Steps: </span><span class="colr">{{funnel.steps.length }}</span></div>
                        <div class=" col-md-4"><span>Last Updated: </span><span class="colr">{{funnel.updated_at | date:'mediumDate'}}</span></div>
                        <!-- <div class="btn-group "> -->
                            <div class="cursor-pointer col-md-2 d-flex justify-content-between" role="button">
                                <!-- <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Settings" matTooltipPosition="above">
                                   More <i class="fas fa-ellipsis-v"></i>
                                </button> -->
                                <!-- <mat-menu #menu="matMenu"> -->
                                    <!-- <button mat-icon-button matTooltip="Quick Edit" [routerLink]="['/funnels/'+funnel.uniqueid]" (click)="openDialog1($event,funnel)">
                                    <i class="fa-regular fa-pen-to-square mr-2" aria-hidden="true"></i>
                                      </button> -->
                                    <button mat-icon-button matTooltip="Edit" (click)="funneledit(funnel.uniqueid, funnel.id,'edit')" >
                                        <i class="fas fa-pencil-alt mr-2" aria-hidden="true"></i>
                                    </button>
                                    <button mat-icon-button matTooltip="Copy" (click)="funneledit(funnel.uniqueid, funnel.id,'copy')" >
                                        <i class="fas fa-link mr-2"></i>
                                    </button>
                                    <button mat-icon-button matTooltip="Duplicate"  (click)="funneledit(funnel.name, funnel.uniqueid,'duplicate')" >
                                        <i class="far fa-clone mr-2"></i>
                                    </button>
                                    <button mat-icon-button matTooltip="Delete" class="text-danger" (click)="funneledit(funnel.uniqueid, funnel.id,'archive')" >
                                        <i class="far fa-trash-alt mr-2"></i>
                                    </button>
                                <!-- </mat-menu> -->
                            <!-- </div> -->

                        </div>
                    </mat-panel-title> 
                       
                    <!-- </header> -->
            </mat-expansion-panel-header>
                    <div class="m-2" *ngFor="let funnelstep of funnel.steps; index as j" [class]="'kbstep-'+funnelstep.uniqueid"  [ngStyle]="{'background-image': 'url(/assets/uploads/images/webpage_thumbnail.jpg)'}" >
                        <div class="keatopstep" [attr.data-border]="funnelstep.color">
                            <div class="keabuilder-item is-moving  row" >
                                <div class="col-sm-4">
                                <h6 class="mb-0 pb-0">{{funnelstep.page_name}}</h6>
                                <!-- <div class="keabuilder-footer d-flex justify-content-between mt-1">
                                    <div class="keabuilder-footer-left d-flex justify-content-between"> -->
                                        <div class="keabuilder-due-date  mt-0 pt-0" matTooltip="Last Updated At" matTooltipPosition="above" >
                                             <span class="font-size-small">Created on: <span class="colr">{{funnelstep.created_at | date:'mediumDate'}}</span></span>
                                        </div>
                                    </div>
                                        <div class="col-sm-1" matTooltip="Variation" matTooltipPosition="above" >
                                            <i class="fas fa-puzzle-piece mr-2"></i> <span
                                                class="font-size-small"><span class="colr">{{funnelstep.variation}}</span></span>
                                        </div>
                                        <div class="col-sm-2" matTooltip="Step Type" matTooltipPosition="above" >
                                            <i class="fas fa-check mr-1"></i> <span
                                                class="font-size-small funnelstypekb"><span class="mr-2">Type:</span><span class="colr">{{funnelstep.funneltype}}</span></span>
                                        </div>
                                        <div class="col-sm-4"  matTooltip="Tags" matTooltipPosition="above" >
                                            <span *ngIf="funnelstep.tag!=''">
                                            <span *ngFor="let tag of funnelstep.tag.split(',')">
                                            <span class="font-size-small m-1"><i class="fas fa-tags mr-1"></i><span class="colr">{{tag}}</span></span>
                                        </span> 
                                        </span> 
                                        </div>  
                                    <div class="col-sm-1 text-right">  
                                        <button  mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Settings" matTooltipPosition="above">
                                            <i class="fa-solid fa-ellipsis-vertical"></i>
                                            <!-- <i class="fas fa-cog"></i> -->
                                        </button>
                                        <mat-menu #menu="matMenu">
                                            
                                            <button mat-menu-item (click)="viewpagestep(funnel.domain, funnel.subdomain, funnelstep.page_path)">
                                                <i class="fas fa-eye mr-2 "></i> View Step
                                            </button>
                                            <button mat-menu-item (click)="funnelstepedit(funnel,funnelstep,'copy')">   
                                                <i class="fas fa-link mr-2"></i> Copy Step Link
                                            </button>
                                            <button mat-menu-item (click)="funnelstepedit(funnel.uniqueid,funnelstep.uniqueid,'edit')">
                                                <i class="fas fa-pencil-alt mr-2" aria-hidden="true" ></i> Edit
                                            </button>
                                            <button mat-menu-item (click)="funnelstepedit(funnelstep.page_path,funnelstep.uniqueid,'duplicate')">
                                                <i class="far fa-clone mr-2"></i> Duplicate
                                            </button>
                                            <button mat-menu-item (click)="openDialog2(dialogduplicate, funnelstep, 'move'); dialogfunnelset=funnel.uniqueid;">
                                                <i class="fa fa-paste mr-2"></i> Move
                                            </button>
                                            <button mat-menu-item (click)="openDialog2(dialogduplicate, funnelstep, 'copymove'); dialogfunnelset=funnel.uniqueid;">
                                                <i class="fa fa-paste mr-2"></i> Copy & Move
                                            </button>
                                            <button mat-menu-item (click)="funnelstepedit(funnelstep.color,funnelstep.uniqueid,'colortheme')">
                                                <i class="far fa-check-circle mr-2"></i> Change Color Badge
                                            </button>
                                            <button mat-menu-item class="text-danger" (click)="funnelstepedit(funnel.uniqueid,funnelstep.uniqueid,'archive')">
                                                <i class="far fa-trash-alt mr-2"></i> Archive
                                            </button>
                                        </mat-menu>

                                    </div>
                                <!-- </div> -->
                                <!-- </div> -->

                            </div>

                            <!-- <div class="kea-footerbar">
                                <button class="mt-3" mat-menu-item (click)="funnelstepedit(funnel.uniqueid,funnelstep.uniqueid,'edit')">
                                    <i class="fas fa-pencil-alt mr-2" aria-hidden="true" ></i> Edit
                                </button>
                                <button mat-menu-item (click)="viewpagestep(funnel.domain, funnel.subdomain, funnelstep.page_path)">
                                    <i class="fas fa-eye mr-2"></i> View Step
                                </button>
                                <button mat-menu-item (click)="funnelstepedit(funnel,funnelstep,'copy')">
                                    <i class="fas fa-link mr-2"></i> Copy Step Link
                                </button>
                                <button mat-menu-item (click)="funnelstepedit(funnelstep.page_path,funnelstep.uniqueid,'duplicate')">
                                    <i class="far fa-clone mr-2"></i> Duplicate
                                </button>
                                <button mat-menu-item (click)="openDialog2(dialogduplicate, funnelstep, 'move'); dialogfunnelset=funnel.uniqueid;">
                                    <i class="fa fa-paste mr-2"></i> Move
                                </button>
                                <button mat-menu-item (click)="openDialog2(dialogduplicate, funnelstep, 'copymove'); dialogfunnelset=funnel.uniqueid;">
                                    <i class="fa fa-paste mr-2"></i> Copy & Move
                                </button>
                                <button mat-menu-item (click)="funnelstepedit(funnelstep.color,funnelstep.uniqueid,'colortheme')">
                                    <i class="far fa-check-circle mr-2"></i> Change Color Badge
                                </button>
                                <button mat-menu-item class="text-danger" (click)="funnelstepedit(funnel.uniqueid,funnelstep.uniqueid,'archive')">
                                    <i class="far fa-trash-alt mr-2"></i> Archive
                                </button>
                            </div> -->

                        </div>


                    </div>
                </mat-expansion-panel>
            </div>
            </mat-accordion>
               
            
            </div>
        
        </div>

        <div class="row">
            <div class="col-md-12">
                <!-- <mat-paginator 
                    [length]="length"
                    [pageSize]="pageSize"
                    [pageSizeOptions]="pageSizeOptions"
                    (page)="getServerData($event)"
                    >
                </mat-paginator> -->
            </div>
        </div>

    </div>
</div>